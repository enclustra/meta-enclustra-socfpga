From aa71082da695fb4ece6c943d997d01b71eaa7c75 Mon Sep 17 00:00:00 2001
From: Lothar Rubusch <lothar.rubusch@enclustra.com>
Date: Fri, 15 Dec 2023 16:20:01 +0000
Subject: [PATCH] dt: setup bootmode as dtbo

Signed-off-by: Lothar Rubusch <lothar.rubusch@enclustra.com>

---
 board/enclustra/bootscripts/qspi-aa1.cmd | 1 +
 board/enclustra/bootscripts/sd-aa1.cmd   | 8 +++-----
 include/configs/socfpga_mercury_aa1.h    | 6 ++++++
 include/configs/socfpga_mercury_sa1.h    | 3 +++
 include/configs/socfpga_mercury_sa2.h    | 3 +++
 5 files changed, 16 insertions(+), 5 deletions(-)

diff --git a/board/enclustra/bootscripts/qspi-aa1.cmd b/board/enclustra/bootscripts/qspi-aa1.cmd
index db518442f0..e64bf71316 100644
--- a/board/enclustra/bootscripts/qspi-aa1.cmd
+++ b/board/enclustra/bootscripts/qspi-aa1.cmd
@@ -3,4 +3,5 @@ sf probe
 sf read ${ram_addr_kernel} ${qspi_offset_addr_kernel} ${size_kernel}
 sf read ${ram_addr_devicetree} ${qspi_offset_addr_devicetree} ${size_devicetree}
 sf read ${ram_addr_rootfs} ${qspi_offset_addr_rootfs} ${size_rootfs}
+run fdtload
 bootm ${ram_addr_kernel} ${ram_addr_rootfs} ${ram_addr_devicetree}
diff --git a/board/enclustra/bootscripts/sd-aa1.cmd b/board/enclustra/bootscripts/sd-aa1.cmd
index bd712c3dc1..8482af452d 100644
--- a/board/enclustra/bootscripts/sd-aa1.cmd
+++ b/board/enclustra/bootscripts/sd-aa1.cmd
@@ -1,8 +1,6 @@
 bridge enable
 fatload mmc 0:1 ${ram_addr_kernel} uImage
 fatload mmc 0:1 ${ram_addr_devicetree} devicetree.dtb
-fatload mmc 0:1 ${ram_addr_rootfs} uramdisk
-
-altera_set_storage QSPI
-
-bootm ${ram_addr_kernel} ${ram_addr_rootfs} ${ram_addr_devicetree}
+altera_set_storage MMC
+run fdtload
+bootm ${ram_addr_kernel} - ${ram_addr_devicetree}
diff --git a/include/configs/socfpga_mercury_aa1.h b/include/configs/socfpga_mercury_aa1.h
index c959070abd..6670c9311b 100644
--- a/include/configs/socfpga_mercury_aa1.h
+++ b/include/configs/socfpga_mercury_aa1.h
@@ -25,6 +25,9 @@
 
 /* U-Boot environment */
 #define SOCFPGA_BOOT_SETTINGS \
+    "devtype=mmc\0" \
+    "distro_bootpart=1\0" \
+    "fdtfile=devicetree.dtb\0" \
     "qspi_offset_addr_spl=0x0\0" \
     "qspi_offset_addr_u-boot=0x100000\0" \
     "qspi_offset_addr_u-boot-env=0x180000\0" \
@@ -44,7 +47,10 @@
     "ram_addr_rootfs=0x12000000\0" \
     "ram_addr_kernel=0x11000000\0" \
     "ram_addr_devicetree=0x10000000\0" \
+    "ram_addr_devicetree_overlay=0x100c0000\0" \
     "ram_addr_boot-script=0x10800000\0" \
+    "fdtofile=socfpga_enclustra_mercury_XXX_overlay.dtbo\0" \
+    "fdtload=load ${devtype} ${devnum}:${distro_bootpart} ${ram_addr_devicetree} ${bootdir}/${fdtfile}; load ${devtype} ${devnum}:${distro_bootpart} ${ram_addr_devicetree_overlay} ${bootdir}/${fdtofile}; fdt addr $ram_addr_devicetree; fdt resize 8191; fdt apply $ram_addr_devicetree_overlay\0" \
     "bootm_size=0x0a000000\0" \
     "bootargs-qspi=earlycon console=ttyS0,115200 rw root=/dev/ram0\0" \
     "bootargs=earlycon console=ttyS0,115200 rw root=/dev/mmcblk0p3\0" \
diff --git a/include/configs/socfpga_mercury_sa1.h b/include/configs/socfpga_mercury_sa1.h
index 0d27bc6d10..cd6944a220 100644
--- a/include/configs/socfpga_mercury_sa1.h
+++ b/include/configs/socfpga_mercury_sa1.h
@@ -34,7 +34,10 @@
     "ram_addr_rootfs=0x12000000\0" \
     "ram_addr_kernel=0x11000000\0" \
     "ram_addr_devicetree=0x10000000\0" \
+    "ram_addr_devicetree_overlay=0x100c0000\0" \
     "ram_addr_boot-script=0x10800000\0" \
+    "fdtofile=socfpga_enclustra_mercury_XXX_overlay.dtbo\0" \
+    "fdtload=load ${devtype} ${devnum}:${distro_bootpart} ${ram_addr_devicetree} ${bootdir}/${fdtfile}; load ${devtype} ${devnum}:${distro_bootpart} ${ram_addr_devicetree_overlay} ${bootdir}/${fdtofile}; fdt addr $ram_addr_devicetree; fdt resize 8191; fdt apply $ram_addr_devicetree_overlay\0" \
     "bootm_size=0x0a000000\0" \
     "bootargs-qspi=earlycon console=ttyS0,115200 rw root=/dev/ram0\0" \
     "bootargs=earlycon console=ttyS0,115200 rw rootwait root=/dev/mmcblk0p3\0" \
diff --git a/include/configs/socfpga_mercury_sa2.h b/include/configs/socfpga_mercury_sa2.h
index f0f6f510b8..56e4ce4f5f 100644
--- a/include/configs/socfpga_mercury_sa2.h
+++ b/include/configs/socfpga_mercury_sa2.h
@@ -34,7 +34,10 @@
     "ram_addr_rootfs=0x12000000\0" \
     "ram_addr_kernel=0x11000000\0" \
     "ram_addr_devicetree=0x10000000\0" \
+    "ram_addr_devicetree_overlay=0x100c0000\0" \
     "ram_addr_boot-script=0x10800000\0" \
+    "fdtofile=socfpga_enclustra_mercury_XXX_overlay.dtbo\0" \
+    "fdtload=load ${devtype} ${devnum}:${distro_bootpart} ${ram_addr_devicetree} ${bootdir}/${fdtfile}; load ${devtype} ${devnum}:${distro_bootpart} ${ram_addr_devicetree_overlay} ${bootdir}/${fdtofile}; fdt addr $ram_addr_devicetree; fdt resize 8191; fdt apply $ram_addr_devicetree_overlay\0" \
     "bootm_size=0x0a000000\0" \
     "bootargs-qspi=earlycon console=ttyS0,115200 rw root=/dev/ram0\0" \
     "bootargs=earlycon console=ttyS0,115200 rw rootwait root=/dev/mmcblk0p3\0" \
