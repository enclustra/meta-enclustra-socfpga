From b064de99b9615f89b7d40be4bd60b1649a02c9e3 Mon Sep 17 00:00:00 2001
From: Lothar Rubusch <lothar.rubusch@enclustra.com>
Date: Tue, 13 Feb 2024 15:14:34 +0000
Subject: [PATCH] dt: fix dtbo setup for qspiboot

Signed-off-by: Lothar Rubusch <lothar.rubusch@enclustra.com>
---
 board/enclustra/bootscripts/qspi-aa1.cmd | 3 +--
 include/configs/socfpga_mercury_aa1.h    | 7 +++++--
 2 files changed, 6 insertions(+), 4 deletions(-)

diff --git a/board/enclustra/bootscripts/qspi-aa1.cmd b/board/enclustra/bootscripts/qspi-aa1.cmd
index e64bf71316..5cd3fc4f91 100644
--- a/board/enclustra/bootscripts/qspi-aa1.cmd
+++ b/board/enclustra/bootscripts/qspi-aa1.cmd
@@ -1,7 +1,6 @@
 bridge enable
 sf probe
 sf read ${ram_addr_kernel} ${qspi_offset_addr_kernel} ${size_kernel}
-sf read ${ram_addr_devicetree} ${qspi_offset_addr_devicetree} ${size_devicetree}
 sf read ${ram_addr_rootfs} ${qspi_offset_addr_rootfs} ${size_rootfs}
-run fdtload
+run fdtload_qspi
 bootm ${ram_addr_kernel} ${ram_addr_rootfs} ${ram_addr_devicetree}
diff --git a/include/configs/socfpga_mercury_aa1.h b/include/configs/socfpga_mercury_aa1.h
index c516524a02..2e12bc90ff 100644
--- a/include/configs/socfpga_mercury_aa1.h
+++ b/include/configs/socfpga_mercury_aa1.h
@@ -33,6 +33,7 @@
     "qspi_offset_addr_u-boot-env=0x180000\0" \
     "qspi_offset_addr_boot-script=0x200000\0" \
     "qspi_offset_addr_devicetree=0x280000\0" \
+    "qspi_offset_addr_dtoverlay=0x2c0000\0" \
     "qspi_offset_addr_bitstream=0x300000\0" \
     "qspi_offset_addr_kernel=0x1000000\0" \
     "qspi_offset_addr_rootfs=0x2000000\0" \
@@ -40,7 +41,8 @@
     "size_u-boot=0x80000\0" \
     "size_u-boot-env=0x80000\0" \
     "size_boot-script=0x80000\0" \
-    "size_devicetree=0x80000\0" \
+    "size_devicetree=0x40000\0" \
+    "size_dtoverlay=0x40000\0" \
     "size_bitstream=0xD00000\0" \
     "size_kernel=0x1000000\0" \
     "size_rootfs=0x2000000\0" \
@@ -50,7 +52,8 @@
     "ram_addr_devicetree_overlay=0x100c0000\0" \
     "ram_addr_boot-script=0x10800000\0" \
     "fdtofile=socfpga_enclustra_mercury_XXX_overlay.dtbo\0" \
-    "fdtload=load ${devtype} ${devnum}:${distro_bootpart} ${ram_addr_devicetree} ${bootdir}/${fdtfile}; load ${devtype} ${devnum}:${distro_bootpart} ${ram_addr_devicetree_overlay} ${bootdir}/${fdtofile}; fdt addr $ram_addr_devicetree; fdt resize 8191; fdt apply $ram_addr_devicetree_overlay\0" \
+    "fdtload=load ${devtype} ${devnum}:${distro_bootpart} ${ram_addr_devicetree} ${bootdir}/${fdtfile}; load ${devtype} ${devnum}:${distro_bootpart} ${ram_addr_devicetree_overlay} ${bootdir}/${fdtofile}; fdt addr $ram_addr_devicetree; fdt resize 8192; fdt apply $ram_addr_devicetree_overlay\0" \
+    "fdtload_qspi=sf probe; sf read ${ram_addr_devicetree} ${qspi_offset_addr_devicetree} ${size_devicetree}; sf read ${ram_addr_devicetree_overlay} ${qspi_offset_addr_dtoverlay} ${size_dtoverlay}; fdt addr ${ram_addr_devicetree}; fdt resize 8192; fdt apply ${ram_addr_devicetree_overlay}\0" \
     "bootm_size=0x0a000000\0" \
     "bootargs-qspi=earlycon console=ttyS0,115200 rw root=/dev/ram0\0" \
     "bootargs=earlycon console=ttyS0,115200 rw root=/dev/mmcblk0p3 rootwait\0" \
-- 
2.34.1

