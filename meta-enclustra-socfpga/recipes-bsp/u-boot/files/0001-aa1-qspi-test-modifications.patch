From c766c7c8209a53c98c0477b27291f9001bdd7bc8 Mon Sep 17 00:00:00 2001
From: Andreas Buerkler <andreas.buerkler@enclustra.com>
Date: Fri, 12 May 2023 15:59:02 +0200
Subject: [PATCH] aa1 qspi test modifications

---
 arch/arm/dts/socfpga_arria10_socdk.dtsi     | 134 +-------------------
 arch/arm/dts/socfpga_arria10_socdk_qspi.dts |  21 +--
 board/altera/arria10-socdk/fit_spl_fpga.its |  12 +-
 3 files changed, 16 insertions(+), 151 deletions(-)

diff --git a/arch/arm/dts/socfpga_arria10_socdk.dtsi b/arch/arm/dts/socfpga_arria10_socdk.dtsi
index 0efbeccc5c..71f58e1c81 100644
--- a/arch/arm/dts/socfpga_arria10_socdk.dtsi
+++ b/arch/arm/dts/socfpga_arria10_socdk.dtsi
@@ -9,7 +9,6 @@
 	compatible = "altr,socfpga-arria10", "altr,socfpga";
 
 	aliases {
-		ethernet0 = &gmac0;
 		serial0 = &uart1;
 	};
 
@@ -21,149 +20,20 @@
 	memory@0 {
 		name = "memory";
 		device_type = "memory";
-		reg = <0x0 0x40000000>; /* 1GB */
-	};
-
-	a10leds {
-		compatible = "gpio-leds";
-
-		a10sr_led0 {
-			label = "a10sr-led0";
-			gpios = <&a10sr_gpio 0 1>;
-		};
-
-		a10sr_led1 {
-			label = "a10sr-led1";
-			gpios = <&a10sr_gpio 1 1>;
-		};
-
-		a10sr_led2 {
-			label = "a10sr-led2";
-			gpios = <&a10sr_gpio 2 1>;
-		};
-
-		a10sr_led3 {
-			label = "a10sr-led3";
-			gpios = <&a10sr_gpio 3 1>;
-		};
-	};
-
-	ref_033v: 033-v-ref {
-		compatible = "regulator-fixed";
-		regulator-name = "0.33V";
-		regulator-min-microvolt = <330000>;
-		regulator-max-microvolt = <330000>;
+		reg = <0x0 0x80000000>; /* 2GB */
 	};
 
 	soc {
 		clkmgr@ffd04000 {
 			clocks {
 				osc1 {
-					clock-frequency = <25000000>;
+					clock-frequency = <33330000>;
 				};
 			};
 		};
 	};
 };
 
-&gmac0 {
-	phy-mode = "rgmii";
-	phy-addr = <0xffffffff>; /* probe for phy addr */
-
-	/*
-	 * These skews assume the user's FPGA design is adding 600ps of delay
-	 * for TX_CLK on Arria 10.
-	 *
-	 * All skews are offset since hardware skew values for the ksz9031
-	 * range from a negative skew to a positive skew.
-	 * See the micrel-ksz90x1.txt Documentation file for details.
-	 */
-	txd0-skew-ps = <0>; /* -420ps */
-	txd1-skew-ps = <0>; /* -420ps */
-	txd2-skew-ps = <0>; /* -420ps */
-	txd3-skew-ps = <0>; /* -420ps */
-	rxd0-skew-ps = <420>; /* 0ps */
-	rxd1-skew-ps = <420>; /* 0ps */
-	rxd2-skew-ps = <420>; /* 0ps */
-	rxd3-skew-ps = <420>; /* 0ps */
-	txen-skew-ps = <0>; /* -420ps */
-	txc-skew-ps = <1860>; /* 960ps */
-	rxdv-skew-ps = <420>; /* 0ps */
-	rxc-skew-ps = <1680>; /* 780ps */
-	max-frame-size = <3800>;
-	status = "okay";
-};
-
-&gpio1 {
-	status = "okay";
-};
-
-&spi1 {
-	status = "okay";
-
-	resource-manager@0 {
-		compatible = "altr,a10sr";
-		reg = <0>;
-		spi-max-frequency = <100000>;
-		/* low-level active IRQ at GPIO1_5 */
-		interrupt-parent = <&portb>;
-		interrupts = <5 IRQ_TYPE_LEVEL_LOW>;
-		interrupt-controller;
-		#interrupt-cells = <2>;
-
-		a10sr_gpio: gpio-controller {
-			compatible = "altr,a10sr-gpio";
-			gpio-controller;
-			#gpio-cells = <2>;
-		};
-
-		a10sr_rst: reset-controller {
-			compatible = "altr,a10sr-reset";
-			#reset-cells = <1>;
-		};
-	};
-};
-
-&i2c1 {
-	status = "okay";
-
-	/*
-	 * adjust the falling times to decrease the i2c frequency to 50Khz
-	 * because the LCD module does not work at the standard 100Khz
-	 */
-	clock-frequency = <100000>;
-	i2c-sda-falling-time-ns = <6000>;
-	i2c-scl-falling-time-ns = <6000>;
-
-	adc@14 {
-		compatible = "lltc,ltc2497";
-		reg = <0x14>;
-		vref-supply = <&ref_033v>;
-	};
-
-	adc@16 {
-		compatible = "lltc,ltc2497";
-		reg = <0x16>;
-		vref-supply = <&ref_033v>;
-	};
-
-	eeprom@51 {
-		compatible = "atmel,24c32";
-		reg = <0x51>;
-		pagesize = <32>;
-	};
-
-	rtc@68 {
-		compatible = "dallas,ds1339";
-		reg = <0x68>;
-	};
-
-	ltc@5c {
-		compatible = "ltc2977";
-		reg = <0x5c>;
-	};
-};
-
 &uart1 {
 	status = "okay";
 };
diff --git a/arch/arm/dts/socfpga_arria10_socdk_qspi.dts b/arch/arm/dts/socfpga_arria10_socdk_qspi.dts
index 60a40e531c..20cd0aef7e 100644
--- a/arch/arm/dts/socfpga_arria10_socdk_qspi.dts
+++ b/arch/arm/dts/socfpga_arria10_socdk_qspi.dts
@@ -9,8 +9,11 @@
 /dts-v1/;
 #include "socfpga_arria10_socdk.dtsi"
 #include "socfpga_arria10_socdk-u-boot.dtsi"
+#include "socfpga_arria10_socdk_qspi_handoff.h"
+#include "socfpga_arria10-handoff.dtsi"
 #include "socfpga_arria10_handoff_u-boot.dtsi"
-#include "socfpga_arria10_socdk_qspi_handoff.dtsi"
+
+
 
 / {
 	aliases {
@@ -20,7 +23,7 @@
 	fs_loader0: fs-loader {
 		u-boot,dm-pre-reloc;
 		compatible = "u-boot,fs-loader";
-		sfconfig = <0 0 100000000 3>;
+		sfconfig = <0 0 50000000 3>;
 	};
 };
 
@@ -42,21 +45,21 @@
 	u-boot,dm-pre-reloc;
 	status = "okay";
 
-	flash0: n25q00a@0 {
+	flash0: s25fl512s@0 {
 		u-boot,dm-pre-reloc;
 		#address-cells = <1>;
 		#size-cells = <1>;
-		compatible = "jedec,spi-nor";
+		compatible = "spansion,s25fl512s", "jedec,spi-nor";
 		reg = <0>;
-		spi-max-frequency = <100000000>;
+		spi-max-frequency = <25000000>;
 
 		page-size = <256>;
 		block-size = <16>; /* 2^16, 64KB */
 		cdns,page-size = <256>;
 		cdns,block-size = <16>;
-		cdns,tshsl-ns = <50>;
-		cdns,tsd2d-ns = <50>;
-		cdns,tchsh-ns = <4>;
-		cdns,tslch-ns = <4>;
+		cdns,tshsl-ns = <200>;
+		cdns,tsd2d-ns = <255>;
+		cdns,tchsh-ns = <20>;
+		cdns,tslch-ns = <20>;
 	};
 };
diff --git a/board/altera/arria10-socdk/fit_spl_fpga.its b/board/altera/arria10-socdk/fit_spl_fpga.its
index adae997213..060858a759 100644
--- a/board/altera/arria10-socdk/fit_spl_fpga.its
+++ b/board/altera/arria10-socdk/fit_spl_fpga.its
@@ -13,15 +13,7 @@
 	images {
 		fpga-periph-1 {
 			description = "FPGA peripheral bitstream";
-			data = /incbin/("../../../ghrd_10as066n2.periph.rbf");
-			type = "fpga";
-			arch = "arm";
-			compression = "none";
-		};
-
-		fpga-core-1 {
-			description = "FPGA core bitstream";
-			data = /incbin/("../../../ghrd_10as066n2.core.rbf");
+			data = /incbin/("../../../fpga.rbf");
 			type = "fpga";
 			arch = "arm";
 			compression = "none";
@@ -32,7 +24,7 @@
 		default = "config-1";
 		config-1 {
 			description = "Boot with FPGA early IO release config";
-			fpga = "fpga-periph-1", "fpga-core-1";
+			fpga = "fpga-periph-1";
 		};
 	};
 };
-- 
2.25.1

