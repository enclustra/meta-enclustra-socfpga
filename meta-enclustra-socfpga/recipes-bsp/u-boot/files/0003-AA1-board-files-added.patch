From cba91822fc222545636950761493712c035b82d4 Mon Sep 17 00:00:00 2001
From: Andreas Buerkler <andreas.buerkler@enclustra.com>
Date: Wed, 19 Jul 2023 18:14:49 +0200
Subject: [PATCH] AA1 board files added

---
 arch/arm/mach-socfpga/Kconfig             |   7 ++
 board/enclustra/mercury_aa1/Kconfig       |  15 ++++
 board/enclustra/mercury_aa1/MAINTAINERS   |   5 ++
 board/enclustra/mercury_aa1/Makefile      |   1 +
 board/enclustra/mercury_aa1/mercury_aa1.c | 102 ++++++++++++++++++++++
 include/configs/socfpga_mercury_aa1.h     |  43 +++++++++
 6 files changed, 173 insertions(+)
 create mode 100644 board/enclustra/mercury_aa1/Kconfig
 create mode 100644 board/enclustra/mercury_aa1/MAINTAINERS
 create mode 100644 board/enclustra/mercury_aa1/Makefile
 create mode 100644 board/enclustra/mercury_aa1/mercury_aa1.c
 create mode 100644 include/configs/socfpga_mercury_aa1.h

diff --git a/arch/arm/mach-socfpga/Kconfig b/arch/arm/mach-socfpga/Kconfig
index 9b00e4fd08..30cce224ae 100644
--- a/arch/arm/mach-socfpga/Kconfig
+++ b/arch/arm/mach-socfpga/Kconfig
@@ -223,6 +223,10 @@ config TARGET_SOCFPGA_TERASIC_SOCKIT
 	bool "Terasic SoCkit (Cyclone V)"
 	select TARGET_SOCFPGA_CYCLONE5
 
+config TARGET_SOCFPGA_ENCLUSTRA_AA1
+	bool "Enclustra Mercury+ AA1"
+	select TARGET_SOCFPGA_ARRIA10
+
 endchoice
 
 config SYS_BOARD
@@ -247,6 +251,7 @@ config SYS_BOARD
 	default "sr1500" if TARGET_SOCFPGA_SR1500
 	default "stratix10-socdk" if TARGET_SOCFPGA_STRATIX10_SOCDK
 	default "vining_fpga" if TARGET_SOCFPGA_SOFTING_VINING_FPGA
+	default "mercury_aa1" if TARGET_SOCFPGA_ENCLUSTRA_AA1
 
 config SYS_VENDOR
 	default "intel" if TARGET_SOCFPGA_AGILEX_N6010
@@ -267,6 +272,7 @@ config SYS_VENDOR
 	default "terasic" if TARGET_SOCFPGA_TERASIC_DE10_NANO
 	default "terasic" if TARGET_SOCFPGA_TERASIC_DE10_STANDARD
 	default "terasic" if TARGET_SOCFPGA_TERASIC_SOCKIT
+	default "enclustra" if TARGET_SOCFPGA_ENCLUSTRA_AA1
 
 config SYS_SOC
 	default "socfpga"
@@ -293,5 +299,6 @@ config SYS_CONFIG_NAME
 	default "socfpga_sr1500" if TARGET_SOCFPGA_SR1500
 	default "socfpga_stratix10_socdk" if TARGET_SOCFPGA_STRATIX10_SOCDK
 	default "socfpga_vining_fpga" if TARGET_SOCFPGA_SOFTING_VINING_FPGA
+	default "socfpga_mercury_aa1" if TARGET_SOCFPGA_ENCLUSTRA_AA1
 
 endif
diff --git a/board/enclustra/mercury_aa1/Kconfig b/board/enclustra/mercury_aa1/Kconfig
new file mode 100644
index 0000000000..d770a48e14
--- /dev/null
+++ b/board/enclustra/mercury_aa1/Kconfig
@@ -0,0 +1,15 @@
+if TARGET_SOCFPGA_ENCLUSTRA_AA1
+
+config SYS_CPU
+	default "armv7"
+
+config SYS_BOARD
+	default "mercury_aa1"
+
+config SYS_VENDOR
+	default "enclustra"
+
+config SYS_CONFIG_NAME
+	default "socfpga_mercury_aa1"
+
+endif
diff --git a/board/enclustra/mercury_aa1/MAINTAINERS b/board/enclustra/mercury_aa1/MAINTAINERS
new file mode 100644
index 0000000000..2281876598
--- /dev/null
+++ b/board/enclustra/mercury_aa1/MAINTAINERS
@@ -0,0 +1,5 @@
+Enclustra Mercury+ AA1
+M:	<info@enclustra.com>
+S:	Maintained
+F:	board/enclustra/mercury_aa1/
+F:	include/configs/socfpga_mercury_aa1.h
diff --git a/board/enclustra/mercury_aa1/Makefile b/board/enclustra/mercury_aa1/Makefile
new file mode 100644
index 0000000000..2a10231b33
--- /dev/null
+++ b/board/enclustra/mercury_aa1/Makefile
@@ -0,0 +1 @@
+obj-y	:= mercury_aa1.o
diff --git a/board/enclustra/mercury_aa1/mercury_aa1.c b/board/enclustra/mercury_aa1/mercury_aa1.c
new file mode 100644
index 0000000000..ebff861fe1
--- /dev/null
+++ b/board/enclustra/mercury_aa1/mercury_aa1.c
@@ -0,0 +1,102 @@
+// SPDX-License-Identifier: GPL-2.0+
+/*
+ * Copyright (C) 2023 Enclustra GmbH
+ * <info@enclustra.com>
+ */
+
+#include <common.h>
+#include <env.h>
+#include <init.h>
+#include <asm/io.h>
+#include <enclustra/eeprom-mac.h>
+
+/* Enclustra vendor ID */
+#define ENCLUSTRA_MAC               0xF7B020
+
+/* Default MAC address */
+#define ENCLUSTRA_ETHADDR_DEFAULT "20:B0:F7:01:02:03"
+#define ENCLUSTRA_ETH1ADDR_DEFAULT "20:B0:F7:01:02:04"
+
+static struct eeprom_mem eeproms[] = {
+	{ .mac_reader = atsha204_get_mac },
+};
+
+int configure_mac(void)
+{
+	int i;
+	u8 hwaddr[6] = {0, 0, 0, 0, 0, 0};
+	u32 hwaddr_h;
+	char hwaddr_str[18];
+	bool hwaddr_set = false;
+
+#ifdef CONFIG_ENCLUSTRA_EEPROM_MAC
+
+	if (env_get("ethaddr")) {
+		/* Address is already set */
+		return 0;
+	}
+
+	for (i = 0; i < ARRAY_SIZE(eeproms); i++) {
+		if (eeproms[i].mac_reader(hwaddr))
+			continue;
+
+		/* Check if the value is a valid mac registered for
+		 * Enclustra  GmbH
+		 */
+		hwaddr_h = hwaddr[0] | hwaddr[1] << 8 | hwaddr[2] << 16;
+		if ((hwaddr_h & 0xFFFFFF) != ENCLUSTRA_MAC)
+			continue;
+
+		/* Format the address using a string */
+		sprintf(hwaddr_str,
+			"%02X:%02X:%02X:%02X:%02X:%02X",
+			hwaddr[0],
+			hwaddr[1],
+			hwaddr[2],
+			hwaddr[3],
+			hwaddr[4],
+			hwaddr[5]);
+
+		/* Set the actual env variable */
+		env_set("ethaddr", hwaddr_str);
+
+		/* increment MAC addr */
+		hwaddr_h = (hwaddr[3] << 16) | (hwaddr[4] << 8) | hwaddr[5];
+		hwaddr_h = (hwaddr_h + 1) & 0xFFFFFF;
+		hwaddr[3] = (hwaddr_h >> 16) & 0xFF;
+		hwaddr[4] = (hwaddr_h >> 8) & 0xFF;
+		hwaddr[5] = hwaddr_h & 0xFF;
+
+		/* Format the address using a string */
+		sprintf(hwaddr_str,
+			"%02X:%02X:%02X:%02X:%02X:%02X",
+			hwaddr[0],
+			hwaddr[1],
+			hwaddr[2],
+			hwaddr[3],
+			hwaddr[4],
+			hwaddr[5]);
+
+		/* Set the actual env variable */
+		env_set("eth1addr", hwaddr_str);
+
+		hwaddr_set = true;
+		break;
+	}
+
+	if (!hwaddr_set) {
+		env_set("ethaddr", ENCLUSTRA_ETHADDR_DEFAULT);
+		env_set("eth1addr", ENCLUSTRA_ETH1ADDR_DEFAULT);
+	}
+
+#endif
+	return 0;
+}
+
+int board_late_init(void)
+{
+	int ret;
+	ret = configure_mac();
+	return ret;
+}
+
diff --git a/include/configs/socfpga_mercury_aa1.h b/include/configs/socfpga_mercury_aa1.h
new file mode 100644
index 0000000000..1ce0977dec
--- /dev/null
+++ b/include/configs/socfpga_mercury_aa1.h
@@ -0,0 +1,43 @@
+/* SPDX-License-Identifier: GPL-2.0+ */
+/*
+ * Copyright (C) 2023 Enclustra GmbH
+ * <info@enclustra.com>
+ */
+
+#ifndef __CONFIG_SOCFGPA_MERCURY_AA1_H__
+#define __CONFIG_SOCFGPA_MERCURY_AA1_H__
+
+#include <asm/arch/base_addr_a10.h>
+
+/*
+ * U-Boot general configurations
+ */
+
+/* Memory configurations  */
+#define PHYS_SDRAM_1_SIZE		0x80000000
+
+/*
+ * Serial / UART configurations
+ */
+#define CONFIG_SYS_NS16550_MEM32
+#define CONFIG_SYS_BAUDRATE_TABLE {4800, 9600, 19200, 38400, 57600, 115200}
+#define CONFIG_SYS_NAND_U_BOOT_OFFS	0x100000
+
+/*
+ * L4 OSC1 Timer 0
+ */
+/* reload value when timer count to zero */
+#define TIMER_LOAD_VAL			0xFFFFFFFF
+
+/* The rest of the configuration is shared */
+#include <configs/socfpga_common.h>
+
+/*
+ * L4 Watchdog
+ */
+#ifdef CONFIG_HW_WATCHDOG
+#undef CONFIG_DW_WDT_BASE
+#define CONFIG_DW_WDT_BASE		SOCFPGA_L4WD1_ADDRESS
+#endif
+
+#endif	/* __CONFIG_SOCFGPA_MERCURY_AA1_H__ */
-- 
2.25.1

